<div class="patient-container">
  <div class="header">
    <h2>Patient Management</h2>
    <div class="header-actions">
      <span class="role-badge" [class.role-user]="authService.isUser()"
                               [class.role-manager]="authService.isManager()"
                               [class.role-admin]="authService.isAdmin()">
        {{ authService.getUserRole() }}
      </span>
      <button *ngIf="authService.canCreatePatients()" class="btn btn-primary" (click)="toggleForm()">
        {{ showForm ? 'Hide Form' : 'Add Patient' }}
      </button>
      <div *ngIf="!authService.canCreatePatients()" class="read-only-notice">
        üìñ Read-Only Access
      </div>
    </div>
  </div>

  <div class="alert alert-success" *ngIf="successMessage">
    {{ successMessage }}
    <button class="close-btn" (click)="successMessage = ''">√ó</button>
  </div>

  <div class="alert alert-error" *ngIf="error">
    {{ error }}
    <button class="close-btn" (click)="error = ''">√ó</button>
  </div>

  <!-- Add Patient Form (Non-modal) -->
  <div class="form-container" *ngIf="showForm && !editMode">
    <h3>Add New Patient</h3>
    <form [formGroup]="patientForm" (ngSubmit)="onSubmit()">
      <div class="form-row">
        <div class="form-group">
          <label>First Name *</label>
          <input type="text" formControlName="firstName" class="form-control"
            [class.invalid]="patientForm.get('firstName')?.invalid && patientForm.get('firstName')?.touched">
          <div class="validation-error" *ngIf="patientForm.get('firstName')?.invalid && patientForm.get('firstName')?.touched">
            ‚ö†Ô∏è First name is required
          </div>
        </div>
        <div class="form-group">
          <label>Last Name *</label>
          <input type="text" formControlName="lastName" class="form-control"
            [class.invalid]="patientForm.get('lastName')?.invalid && patientForm.get('lastName')?.touched">
          <div class="validation-error" *ngIf="patientForm.get('lastName')?.invalid && patientForm.get('lastName')?.touched">
            ‚ö†Ô∏è Last name is required
          </div>
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label>Date of Birth *</label>
          <input type="date" formControlName="dateOfBirth" class="form-control"
            [class.invalid]="patientForm.get('dateOfBirth')?.invalid && patientForm.get('dateOfBirth')?.touched">
          <div class="validation-error" *ngIf="patientForm.get('dateOfBirth')?.invalid && patientForm.get('dateOfBirth')?.touched">
            ‚ö†Ô∏è Date of birth is required
          </div>
        </div>
        <div class="form-group">
          <label>Phone *</label>
          <input type="text" formControlName="phone" class="form-control"
            [class.invalid]="patientForm.get('phone')?.invalid && patientForm.get('phone')?.touched">
          <div class="validation-error" *ngIf="patientForm.get('phone')?.invalid && patientForm.get('phone')?.touched">
            ‚ö†Ô∏è Phone number is required
          </div>
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label>Email *</label>
          <input type="email" formControlName="email" class="form-control"
            [class.invalid]="patientForm.get('email')?.invalid && patientForm.get('email')?.touched">
          <div class="validation-error" *ngIf="patientForm.get('email')?.invalid && patientForm.get('email')?.touched">
            <span *ngIf="patientForm.get('email')?.errors?.['required']">‚ö†Ô∏è Email is required</span>
            <span *ngIf="patientForm.get('email')?.errors?.['email']">‚ö†Ô∏è Please enter a valid email address</span>
          </div>
        </div>
        <div class="form-group">
          <label>Office *</label>
          <select formControlName="officeId" class="form-control"
            [class.invalid]="patientForm.get('officeId')?.invalid && patientForm.get('officeId')?.touched">
            <option value="" disabled>Select an office...</option>
            <option *ngFor="let office of offices" [value]="office.id">
              {{ office.name }} - {{ office.address }}
            </option>
          </select>
          <div class="validation-error" *ngIf="patientForm.get('officeId')?.invalid && patientForm.get('officeId')?.touched">
            ‚ö†Ô∏è Please select an office
          </div>
        </div>
      </div>

      <div class="form-group full-width">
        <label>Address *</label>
        <textarea formControlName="address" class="form-control"
          [class.invalid]="patientForm.get('address')?.invalid && patientForm.get('address')?.touched"></textarea>
        <div class="validation-error" *ngIf="patientForm.get('address')?.invalid && patientForm.get('address')?.touched">
          ‚ö†Ô∏è Address is required
        </div>
      </div>

      <div class="form-group full-width">
        <label>Assign Caregivers</label>
        <div class="caregivers-selection">
          <div class="caregiver-checkbox-item" *ngFor="let caregiver of caregivers">
            <label class="checkbox-label">
              <input
                type="checkbox"
                [value]="caregiver.id"
                [checked]="isCaregiverSelected(caregiver.id)"
                (change)="toggleCaregiver(caregiver.id)"
                class="checkbox-input">
              <span class="checkbox-text">
                <strong>{{ caregiver.firstName }} {{ caregiver.lastName }}</strong>
                <span class="specialization-tag">{{ caregiver.specialization }}</span>
              </span>
            </label>
          </div>
          <div class="no-caregivers" *ngIf="caregivers.length === 0">
            No caregivers available for the selected office
          </div>
        </div>
      </div>

      <div class="form-actions">
        <button type="submit" class="btn btn-success" [disabled]="!patientForm.valid || loading">
          {{ loading ? 'Saving...' : 'Create' }}
        </button>
        <button type="button" class="btn btn-secondary" (click)="resetForm()">Cancel</button>
      </div>
    </form>
  </div>

  <!-- Edit Patient Modal -->
  <div class="modal-overlay" *ngIf="editMode" (click)="closeModal()">
    <div class="modal-container" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>Edit Patient</h3>
        <button class="modal-close-btn" (click)="closeModal()">&times;</button>
      </div>
      <div class="modal-body">
        <form [formGroup]="patientForm" (ngSubmit)="onSubmit()">
          <div class="form-row">
            <div class="form-group">
              <label>First Name *</label>
              <input type="text" formControlName="firstName" class="form-control"
                [class.invalid]="patientForm.get('firstName')?.invalid && patientForm.get('firstName')?.touched">
              <div class="validation-error" *ngIf="patientForm.get('firstName')?.invalid && patientForm.get('firstName')?.touched">
                ‚ö†Ô∏è First name is required
              </div>
            </div>
            <div class="form-group">
              <label>Last Name *</label>
              <input type="text" formControlName="lastName" class="form-control"
                [class.invalid]="patientForm.get('lastName')?.invalid && patientForm.get('lastName')?.touched">
              <div class="validation-error" *ngIf="patientForm.get('lastName')?.invalid && patientForm.get('lastName')?.touched">
                ‚ö†Ô∏è Last name is required
              </div>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label>Date of Birth *</label>
              <input type="date" formControlName="dateOfBirth" class="form-control"
                [class.invalid]="patientForm.get('dateOfBirth')?.invalid && patientForm.get('dateOfBirth')?.touched">
              <div class="validation-error" *ngIf="patientForm.get('dateOfBirth')?.invalid && patientForm.get('dateOfBirth')?.touched">
                ‚ö†Ô∏è Date of birth is required
              </div>
            </div>
            <div class="form-group">
              <label>Phone *</label>
              <input type="text" formControlName="phone" class="form-control"
                [class.invalid]="patientForm.get('phone')?.invalid && patientForm.get('phone')?.touched">
              <div class="validation-error" *ngIf="patientForm.get('phone')?.invalid && patientForm.get('phone')?.touched">
                ‚ö†Ô∏è Phone number is required
              </div>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label>Email *</label>
              <input type="email" formControlName="email" class="form-control"
                [class.invalid]="patientForm.get('email')?.invalid && patientForm.get('email')?.touched">
              <div class="validation-error" *ngIf="patientForm.get('email')?.invalid && patientForm.get('email')?.touched">
                <span *ngIf="patientForm.get('email')?.errors?.['required']">‚ö†Ô∏è Email is required</span>
                <span *ngIf="patientForm.get('email')?.errors?.['email']">‚ö†Ô∏è Please enter a valid email address</span>
              </div>
            </div>
            <div class="form-group">
              <label>Office *</label>
              <select formControlName="officeId" class="form-control"
                [class.invalid]="patientForm.get('officeId')?.invalid && patientForm.get('officeId')?.touched">
                <option value="" disabled>Select an office...</option>
                <option *ngFor="let office of offices" [value]="office.id">
                  {{ office.name }} - {{ office.address }}
                </option>
              </select>
              <div class="validation-error" *ngIf="patientForm.get('officeId')?.invalid && patientForm.get('officeId')?.touched">
                ‚ö†Ô∏è Please select an office
              </div>
            </div>
          </div>

          <div class="form-group full-width">
            <label>Address *</label>
            <textarea formControlName="address" class="form-control"
              [class.invalid]="patientForm.get('address')?.invalid && patientForm.get('address')?.touched"></textarea>
            <div class="validation-error" *ngIf="patientForm.get('address')?.invalid && patientForm.get('address')?.touched">
              ‚ö†Ô∏è Address is required
            </div>
          </div>

          <div class="form-group full-width">
            <label>Assign Caregivers</label>
            <div class="caregivers-selection">
              <div class="caregiver-checkbox-item" *ngFor="let caregiver of caregivers">
                <label class="checkbox-label">
                  <input
                    type="checkbox"
                    [value]="caregiver.id"
                    [checked]="isCaregiverSelected(caregiver.id)"
                    (change)="toggleCaregiver(caregiver.id)"
                    class="checkbox-input">
                  <span class="checkbox-text">
                    <strong>{{ caregiver.firstName }} {{ caregiver.lastName }}</strong>
                    <span class="specialization-tag">{{ caregiver.specialization }}</span>
                  </span>
                </label>
              </div>
              <div class="no-caregivers" *ngIf="caregivers.length === 0">
                No caregivers available for the selected office
              </div>
            </div>
          </div>

          <div class="form-actions">
            <button type="submit" class="btn btn-success" [disabled]="!patientForm.valid || loading">
              {{ loading ? 'Updating...' : 'Update Patient' }}
            </button>
            <button type="button" class="btn btn-secondary" (click)="closeModal()">Cancel</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <div class="loading" *ngIf="loading && !showForm">Loading...</div>

  <div class="grid-container" *ngIf="!loading">
    <table class="patient-grid">
      <thead>
        <tr>
          <th class="row-number-header">#</th>
          <th>ID</th>
          <th class="sortable" (click)="sortColumn('firstName')">
            Name <span class="sort-icon">{{ getSortIcon('firstName') }}</span>
          </th>
          <th class="sortable" (click)="sortColumn('dateOfBirth')">
            Date of Birth <span class="sort-icon">{{ getSortIcon('dateOfBirth') }}</span>
          </th>
          <th class="sortable" (click)="sortColumn('phone')">
            Phone <span class="sort-icon">{{ getSortIcon('phone') }}</span>
          </th>
          <th class="sortable" (click)="sortColumn('email')">
            Email <span class="sort-icon">{{ getSortIcon('email') }}</span>
          </th>
          <th>Caregivers</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let patient of patients; let i = index">
          <td class="row-number">{{ getRowNumber(i) }}</td>
          <td>{{ patient.id }}</td>
          <td>{{ patient.firstName }} {{ patient.lastName }}</td>
          <td>{{ patient.dateOfBirth | date:'shortDate' }}</td>
          <td>{{ patient.phone }}</td>
          <td>{{ patient.email }}</td>
          <td>
            <div class="caregivers-list">
              <span *ngFor="let caregiver of patient.caregivers" class="caregiver-badge">
                {{ caregiver.firstName }} {{ caregiver.lastName }}
              </span>
            </div>
          </td>
          <td>
            <div class="action-buttons">
              <button *ngIf="authService.canEditPatients()" class="btn btn-sm btn-info" (click)="editPatient(patient)">Edit</button>
              <button *ngIf="authService.canDeletePatients()" class="btn btn-sm btn-danger" (click)="deletePatient(patient.id)">Delete</button>
              <span *ngIf="!authService.canEditPatients() && !authService.canDeletePatients()" class="no-actions">
                View Only
              </span>
            </div>
          </td>
        </tr>
      </tbody>
    </table>

    <div class="pagination">
      <button (click)="onPageChange(page - 1)" [disabled]="page === 1" class="btn btn-sm">Previous</button>
      <div class="pagination-info">
        <span class="page-range">Showing {{ getStartRecord() }}-{{ getEndRecord() }} of {{ totalCount }} patients</span>
        <span class="page-number">Page {{ page }} of {{ totalPages }}</span>
      </div>
      <button (click)="onPageChange(page + 1)" [disabled]="page === totalPages || totalPages === 0" class="btn btn-sm">Next</button>
    </div>
  </div>
</div>
